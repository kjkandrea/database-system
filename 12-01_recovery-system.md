# 회복 시스템

## 시스템 실패(system failure)의 유형

* 트랜잭션 실패
  * 논리적: 잘못된 데이터 입력, 부재, 버퍼 오버플로, 자원 초과
  * 시스템적: 운용 시스템의 교착상태
* 시스템 장애
  * 시스템의 하드웨어 고장, 소프트웨어 오류
  * 주기억장치와 같은 휘발성 저장장치의 내용 손실
* 디스크 싪 
  * 비휘발성 디스크 저장장치의 손상 및 고장으로 인한 데이터 손실

## 회복 데이터의 구성

* 백업: 복제된 데이터베이스
* 로그: 수정사항 기록

## 메인 메모리와 디스크 사이의 연산

* Input(X): 물리적 블록 X를 메인 메모리에 적재
* Output(X): 버퍼 블록 X를 디스크에 저장

## 로그 기반 회복

### 로그 레코드

* `<Ti, Xj, V1, V2>` : Ti가 데이터 항목 변경 연산을 수행하여 Xj의 값을 V1에서 V2로 변경
* `<Ti, start>` : Ti 가 시작
* `<Ti, commit>` : Ti 가 커밋
* `<Ti, abort>` : Ti 가 취소

WAL; Write-Ahead Log

트랜잭션은 데이터베이스 수정 전, 로그 레코드를 생성하여 기록

* 트랜잭션이 메인 메모리의 개인 영역에서 여러 연산을 수행
* 트랜잭션이 데이터 항목이 존재하는 메인 메모리에 위치한 버퍼 블럭의 데이터를 변경
* Output 명령을 실행하여 버퍼 블럭을 디스크에 기록

### Redo & Undo

* Redo: 다시 한다. 트랙잭션에 의해 수정된 새로운 값으로 데이터베이스의 데이터 항목값을 수정
* Undo: 되돌린다. 트랜잭션에 의해 수정된 모든 데이터 항목을 이전 값으로 복귀. 완료 후 `<Ti, abort>` 기록

* 로그에 `<Ti, start>` 가 있지만 `<Ti, commit>`, `<Ti, abort>` 가 없는 경우 Ti는 Undo
* 로그에 `<Ti, start>` 가 있지만 `<Ti, commit>`, `<Ti, abort>` 를 포함하는 경우 Redo

### 회복의 유형

#### 지연 갱신 회복(deferred update restore)

* 부분 커밋까지 디스크 반영을 지연시키고 로그에만 기록
* 실패 시, 별도의 회복 작업 필요 없이 로그만 수정

#### 즉시 갱신 회복(immediate update restore)

* 갱신 요청을 곧바로 디스크에 반영
* 실패 시, 디스크에 반영된 갱신 내용을 로그를 바탕으로 회복

### 체크포인트

1. 현재 시점에 메인 메모리의 버퍼 블럭에 존재하는 모든 로그 레코드를 안정 저장장치에 기록
2. 수정된 모든 버퍼 블럭을 디스크에 반영
3. 로그 레코드 checkpoint list 를 안전한 저장장치에 기록

## 회복 알고리즘

### 특정 트랜잭션에 대해

1. 로그를 역방향으로 탐색
2. Ti의 로그 레코드 `<Ti, Xj, V1, V2>`에 대하여
   * 데이터 항목 Xj에 V1 기록
   * 로그 레코드 `<Ti, Xj, V1>` 를 로그에 기록
3. `<Ti, start>` 를 찾은 이후
   * 역방향 탐색을 중단
   * 로그 레코드 `<Ti, abort>` 를 로그에 기록

### 시스템 장애 이후 재시작 시

Redo 단계

1. 최근의 체크포인트에서부터 순방향 로그 탐색
2. 롤백 대상 트랜잭션의 Undo 리스트인 ListofUndo 를 ListT로 초기화
3. `<Ti, Xj, V1, V2>`, `<Ti, Xj, V1>` 형태의 모든 레코드 재실행
4. `<Ti, start>` 발견 시, Ti를 ListofUndo 에 추가
5. `<Ti, abort>`, `<Ti, commit>` 발견 시 Ti를 Undo 리스트에서 제거

Undo 단계
